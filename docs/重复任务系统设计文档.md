
# 重复任务系统设计文档

## 1. 概述

本文档描述个人任务管理系统中**重复任务**的设计逻辑和核心概念。

### 核心设计原则
- **模板+实例分离**：模板存储重复规则，实例是具体的可执行任务
- **创建时全量生成**：用户创建重复任务时，立即生成所有实例（不使用定时任务）
- **独立管理**：每个实例可独立完成/取消，互不影响
- **Serverless友好**：适配 Cloudflare Workers 环境，无需定时任务基础设施

---

## 2. 数据结构

### 2.1 RecurringRule 类型

重复规则的JSON结构，包含以下字段：

- `freq`：频率类型，支持 `'daily'` | `'weekly'` | `'monthly'`
- `interval`：间隔数（例如：每2周 = interval: 2）
- `startDate`：开始日期 YYYY-MM-DD（必填）
- `endDate`：结束日期 YYYY-MM-DD（可选，与 endAfterOccurrences 二选一）
- `endAfterOccurrences`：重复N次后结束（可选，与 endDate 二选一）
- `daysOfWeek`：周几数组（0=周日, 1=周一...6=周六），仅 weekly 使用
- `dayOfMonth`：每月几号（1-31），仅 monthly 使用

### 2.2 Task 表核心字段

**基本信息**
- `id`：主键
- `title`：任务标题
- `description`：任务描述
- `status`：状态，枚举值 `'pending'` | `'completed'` | `'cancelled'`

**时间字段**
- `dueDate`：执行日期（YYYY-MM-DD）
  - 具体任务：有日期
  - 模板任务：为 **NULL**
- `startTime`：开始时间（HH:MM）
  - 有值：定时任务
  - NULL：全天任务
- `endTime`：结束时间（HH:MM）

**重复任务逻辑**
- `isRecurring`：布尔值，标记是否为重复任务
- `recurringRule`：JSON类型，存储 RecurringRule
- `recurringParentId`：整型，指向模板任务的 id
  - 外键关系：`onDelete: 'cascade'`（删除模板时级联删除所有实例）

**归属字段**
- `createdBy`：创建者用户id
- `assignedTo`：分配给谁
- `completedBy`：完成者用户id
- `completedAt`：完成时间

**时间戳**
- `createdAt`：创建时间
- `updatedAt`：更新时间

---

## 3. 任务分类逻辑

### 3.1 一次性任务（全天）
- `dueDate`：有具体日期
- `startTime`：NULL
- `endTime`：NULL
- `isRecurring`：false
- `recurringParentId`：NULL

### 3.2 一次性任务（定时）
- `dueDate`：有具体日期
- `startTime`：有具体时间
- `endTime`：有具体时间
- `isRecurring`：false
- `recurringParentId`：NULL

### 3.3 重复任务模板
- `dueDate`：**NULL**（模板不代表某一天）
- `startTime`：可能有值或NULL
- `endTime`：可能有值或NULL
- `isRecurring`：**true**
- `recurringParentId`：**NULL**（自己是顶层模板）
- `recurringRule`：包含完整的重复规则

### 3.4 重复任务实例
- `dueDate`：**有具体日期**（从模板生成的某一天）
- `startTime`：从模板继承
- `endTime`：从模板继承
- `isRecurring`：**false**（实例本身不重复）
- `recurringParentId`：**指向模板任务的id**
- `recurringRule`：NULL（实例不存储规则）

---

## 4. 判断任务类型的逻辑

**判断是模板任务**
- `isRecurring = true` AND `recurringParentId IS NULL`

**判断是实例任务**
- `recurringParentId IS NOT NULL`

**判断是普通一次性任务**
- `isRecurring = false` AND `recurringParentId IS NULL`

**用户界面展示的任务（排除模板）**
- `dueDate IS NOT NULL`
- 或者：`isRecurring = false OR recurringParentId IS NOT NULL`

---

## 4.5 字段验证规则

### 基础字段
- **title**：必填，1-200字符
- **description**：必填，至少1字符
- **dueDate**：
  - 一次性任务：必填
  - 重复任务：不填写（由系统生成实例时自动设置）

### 分配人字段
- **assignedToIds**：
  - 个人任务（groupId = null）：
    - 自动分配给当前用户
    - 不可修改，前端禁用取消勾选
  - 群组任务（groupId != null）：
    - 必须至少选择一个用户
    - 所有选择的用户必须是群组成员

### 时间字段
- **startTime/endTime**：
  - 全天任务：两者都为 NULL
  - 定时任务：两者都必填，且符合 HH:MM 或 HH:MM:SS 格式

---

## 5. 创建重复任务流程

### 5.1 用户输入

用户提供以下信息：
- 任务基本信息（标题、描述、时间等）
- 重复规则（RecurringRule）

### 5.2 验证规则

**必须满足的条件：**

1. **基础字段验证**
   - 任务标题（title）：必填，1-200字符
   - 任务描述（description）：必填，至少1字符
   - 执行日期（dueDate）：一次性任务必填，重复任务不填写

2. **分配人规则**
   - 个人任务（groupId = null）：
     - 默认分配给当前用户
     - 不可修改（前端禁用取消勾选）
   - 群组任务（groupId != null）：
     - 必须至少选择一个用户
     - 所有被分配的用户必须是该群组的成员

3. **重复任务结束条件**
   - 如果未指定 `endDate` 和 `endAfterOccurrences`，系统自动将 `endDate` 设置为开始日期后1年
   - 如果指定 `endDate`，必须满足：
     - 不能是今天或之前的日期（必须是明天或以后）
     - 不能超过开始日期后1年（时间跨度 ≤ 365天）
     - 必须晚于开始日期
   - 如果指定 `endAfterOccurrences`，不能超过365次

4. **频率特定验证**
   - 如果 `freq = 'weekly'`，必须选择至少一个星期几（`daysOfWeek`）
   - 如果 `freq = 'monthly'`，必须指定每月第几天（`dayOfMonth`，1-31）

### 5.3 创建流程（同一事务内完成）

**Step 1：创建模板任务**
- 插入一条记录到 tasks 表
- `dueDate` 设为 NULL
- `isRecurring` 设为 true
- `recurringParentId` 设为 NULL
- `recurringRule` 保存完整的重复规则
- 获取插入后的模板任务 id

**Step 2：计算生成的日期列表**
- 根据 `recurringRule` 中的频率、间隔、开始日期、结束条件计算
- 例如：每天重复，从2月3日到3月3日，生成30个日期
- 例如：每周一三五，重复12次，生成12个日期

**Step 3：批量生成实例任务**
- 遍历日期列表，为每个日期创建一条任务记录
- 每条记录：
  - `dueDate` 设为计算出的具体日期
  - `startTime/endTime` 从模板继承
  - `isRecurring` 设为 false
  - `recurringParentId` 指向模板任务id
  - `recurringRule` 设为 NULL
  - 其他字段（title、description、createdBy等）从模板复制

**Step 4：返回结果**
- 返回模板id和生成的实例数量

---

## 6. 修改重复任务逻辑

采用**删除重建策略**。

### 6.1 修改流程

**Step 1：删除所有未完成的旧实例**
- 查找所有 `recurringParentId = 模板id` 且 `status = 'pending'` 的任务
- 批量删除这些记录
- 已完成（completed）或已取消（cancelled）的实例保留

**Step 2：更新模板任务**
- 更新模板任务的字段（title、startTime、recurringRule等）
- 更新 `updatedAt` 时间戳

**Step 3：重新生成实例**
- 根据新的规则重新计算日期列表
- 批量插入新的实例任务

### 6.2 为什么选择删除重建？

**优点：**
- 逻辑简单，代码易维护
- 如果规则变化大（如从每天改成每周），更新逻辑会很复杂
- 只删除 pending 状态的任务，历史记录保留

**注意：**
- 实例任务的 id 会变化，但对个人任务管理影响不大

---

## 7. 删除重复任务逻辑

### 7.1 删除模板任务

- 删除模板任务时，通过外键的 `onDelete: 'cascade'` 自动级联删除所有实例
- 一次删除操作即可清理模板和所有相关实例

### 7.2 删除单个实例任务

- 只删除该实例任务记录
- 不影响模板和其他实例
- 用户可以单独取消某一天的任务而保留其他天

---

## 8. 查询逻辑

### 8.1 获取用户的任务列表（排除模板）

**查询条件：**
- `createdBy = 用户id` 或 `assignedTo = 用户id`
- `dueDate IS NOT NULL`（排除模板）
- 按需过滤 status（pending/completed/cancelled）
- 按日期和时间排序

### 8.2 获取用户的重复任务模板

**查询条件：**
- `createdBy = 用户id`
- `isRecurring = true`
- `recurringParentId IS NULL`
- 按创建时间倒序排列

### 8.3 获取某个模板的所有实例

**查询条件：**
- `recurringParentId = 模板id`
- 按 dueDate 排序

### 8.4 检测时间冲突

**查询条件：**
- `assignedTo = 用户id`
- `dueDate = 指定日期`
- `status = 'pending'`
- `startTime/endTime` 与待检测的时间段有重叠
- 排除全天任务（startTime IS NULL）

---

## 9. 典型使用场景

### 场景1：下个月每天中午12点打卡

**用户创建：**
- 今天（2024-02-01）创建
- 标题："午间打卡"
- 时间：12:00-12:15
- 规则：每天（daily），从 2024-02-03 到 2024-03-03

**系统生成：**
- 1个模板任务（dueDate = NULL）
- 30个实例任务（dueDate 从 2024-02-03 到 2024-03-03）

**用户看到：**
- 任务列表显示30个任务，可以逐个完成

### 场景2：每周一三五早上9点开会，重复12次

**用户创建：**
- 标题："团队晨会"
- 时间：09:00-10:00
- 规则：每周（weekly），周一三五，从 2024-02-05 开始，重复12次

**系统生成：**
- 1个模板任务
- 12个实例任务（分布在4周的周一、三、五）

### 场景3：每月5号交房租（全天任务）

**用户创建：**
- 标题："交房租"
- 时间：全天（startTime/endTime = NULL）
- 规则：每月（monthly），5号，从 2024-02-05 开始，重复12次

**系统生成：**
- 1个模板任务
- 12个实例任务（2024-02-05, 2024-03-05, ..., 2025-01-05）

### 场景4：修改打卡时间从12点改成14点

**用户操作：**
- 修改模板任务的 startTime 为 14:00

**系统处理：**
1. 删除所有未完成的旧实例（12点的任务）
2. 更新模板的 startTime 为 14:00
3. 重新生成30个新实例（14点的任务）
4. 已完成的历史记录保留

---

## 10. 边界情况处理

### 10.1 全天任务
- `startTime = NULL` 且 `endTime = NULL`
- 用户界面显示为"全天"
- 不参与时间冲突检测

### 10.2 结束条件的两种方式

**方式1：指定结束日期**
- 生成从 startDate 到 endDate 之间所有符合规则的日期

**方式2：指定重复次数**
- 从 startDate 开始，生成指定次数后停止

### 10.3 月份日期溢出

例如：每月31号重复，但2月只有28/29天
- **建议处理方式1**：跳过该月（2月不生成任务）
- **建议处理方式2**：取该月最后一天（2月28日或29日）

实现时需要特殊处理这种情况。

### 10.4 无限重复任务

**不支持**。必须强制要求用户指定：
- `endDate`（结束日期），或
- `endAfterOccurrences`（重复次数）

如果都不指定，业务逻辑抛出错误。

---

## 11. 性能考虑

### 11.1 批量插入

- 生成实例任务时使用批量插入，不要逐条插入
- 使用数据库事务保证原子性
- 一次可能插入30-365条记录

### 11.2 数据库索引建议

- `recurringParentId`：加速查询模板的所有实例
- `dueDate`：加速按日期查询任务
- `(createdBy, status)`：加速查询用户的待办任务
- `(assignedTo, dueDate)`：加速查询分配给用户的任务

### 11.3 查询优化

- 分页加载任务列表，避免一次查询过多数据
- 使用日期范围过滤，不要加载所有历史任务

---

## 12. 常见问题

### Q1: 为什么模板的 dueDate 必须为 NULL？
**A:** 模板不代表某一天的具体任务，只存储"如何生成任务"的规则。用 NULL 可以清晰区分模板和实例，查询时也方便过滤。

### Q2: 用户修改一个实例的时间，会影响其他实例吗？
**A:** 不会。每个实例是独立的任务记录，互不影响。如果要批量修改，需要修改模板并重新生成。

### Q3: 为什么不用定时任务滚动生成实例？
**A:** 因为部署在 Cloudflare Workers（Serverless），不适合运行持续的定时任务。创建时全量生成更简单可靠。

### Q4: 没指定结束日期会怎样？
**A:** 如果用户既不指定 endDate 也不指定 endAfterOccurrences，系统会自动将 endDate 设置为开始日期后1年。前端会显示提示告知用户默认的结束日期。

### Q5: 模板任务会显示在用户的任务列表吗？
**A:** 不会。查询时用 `dueDate IS NOT NULL` 或 `recurringParentId IS NOT NULL` 排除模板，用户只看到具体的实例任务。

### Q6: 删除模板时实例会一起删除吗？
**A:** 是的。通过外键的 `onDelete: 'cascade'` 自动级联删除所有实例（包括已完成和未完成的）。

---

## 13. 数据关系总结

| 任务类型 | dueDate | isRecurring | recurringParentId | 用户可见 |
|---------|---------|-------------|-------------------|---------|
| 一次性任务 | 具体日期 | false | NULL | ✅ 是 |
| **重复任务模板** | **NULL** | **true** | **NULL** | ❌ 否 |
| 重复任务实例 | 具体日期 | false | 模板id | ✅ 是 |

**关系：**
- 1个模板任务 → N个实例任务（1 ≤ N ≤ 365）
- 外键关系：`recurringParentId` → `tasks.id`，级联删除
- 修改模板时：删除所有 pending 实例 → 重新生成新实例
- 已完成的实例：保留历史记录，不受模板修改影响

---

## 14. 实现检查清单

开发时确保以下逻辑正确实现：

**基础验证：**
- [ ] 任务标题必填（1-200字符）
- [ ] 任务描述必填（至少1字符）
- [ ] 一次性任务的 dueDate 必填
- [ ] 个人任务自动分配给当前用户，前端禁用取消勾选
- [ ] 群组任务必须至少分配给一个用户
- [ ] 所有被分配的用户必须是群组成员（群组任务）

**重复任务验证：**
- [ ] 如果未指定 endDate 和 endAfterOccurrences，自动设置 endDate 为1年后
- [ ] 如果指定 endDate，必须是明天或以后的日期（不能是今天或之前）
- [ ] 限制最大生成数量不超过1年（365天或365次）
- [ ] 每周重复必须选择至少一个星期几
- [ ] 每月重复必须指定每月第几天（1-31）

**重复任务创建：**
- [ ] 创建模板和实例必须在同一事务内完成
- [ ] 模板的 dueDate 必须为 NULL
- [ ] 实例的 recurringParentId 必须指向模板
- [ ] 实例的 isRecurring 必须为 false
- [ ] 批量插入实例时使用数据库事务

**查询和修改：**
- [ ] 查询用户任务时必须排除模板（dueDate IS NOT NULL）
- [ ] 修改模板时只删除 status='pending' 的实例
- [ ] 删除模板时通过外键级联删除所有实例
- [ ] 时间冲突检测要排除全天任务（startTime IS NULL）

**性能优化：**
- [ ] 必要的字段添加数据库索引
