# AI Agent System Prompt 改进需求文档

> 文档版本：v1.1
> 最后更新：2026-02-07
> 状态：需求已确认，System Prompt 终稿已定

---

## 一、项目背景

### 1.1 改进范围
- **Prompt + 代码重构**：同时优化 System Prompt 和精简代码中的 workaround 逻辑
- **重点关注**：整体交互体验（回复风格、确认逻辑、错误提示等）

### 1.2 当前代码问题（已分析）

**System Prompt 分散在4个位置：**
```
Layer 1: buildSystemPrompt() - ai.service.ts 第258-288行
Layer 2: supplementalRules - ai.service.ts 第678-679行
Layer 3: forceSegmentHint - ai.service.ts 第680-685行（条件性）
Layer 4: TOOL_DEFINITIONS - ai.service.ts 第19-169行
```

**主要问题：**
1. 规则分散且重复，存在潜在矛盾
2. 过度依赖代码层面的 Workaround（hasTimeSegmentHint等方法）
3. 规则平铺无结构，缺乏优先级
4. 缺少 Few-shot 示例

### 1.3 技术方案决策

- **单 Agent + 多 Tool** 架构，不使用子 Agent（工具仅5个，复杂度不需要拆分）
- **Prompt 与代码分工原则**：Prompt 负责语义理解和对话管理，代码负责确定性逻辑（权限校验、数据库查询等）
- **Prompt 中不允许黑盒**：所有 LLM 需要感知的逻辑都必须在 Prompt 中写清楚，不能出现"由系统自动处理"这类模糊描述

---

## 二、核心需求

### 2.1 功能概述

用户通过文字发送任务操作请求 → AI Agent 理解意图 → 调用对应工具执行操作

**支持的操作：**
- 创建任务
- 查询任务
- 更新任务
- 删除任务
- 完成任务

**权限原则：** 用户只能操作自己的任务（权限校验由代码层处理）

---

## 三、时间段需求

### 3.1 时间类型

| 类型 | 说明 | 示例 |
|------|------|------|
| 具体时间段 | 精确的开始和结束时间 | 下午3点到5点 |
| 模糊时间段 | 7个预定义时间段之一 | 上午、晚上、全天等 |

### 3.2 模糊时间段定义（7个）

| 时间段 | 枚举值 | 参考时间范围 |
|--------|--------|--------------|
| 全天 | all_day | 00:00 - 23:59 |
| 凌晨 | early_morning | 00:00 - 05:59 |
| 早上 | morning | 06:00 - 08:59 |
| 上午 | forenoon | 09:00 - 11:59 |
| 中午 | noon | 12:00 - 13:59 |
| 下午 | afternoon | 14:00 - 17:59 |
| 晚上 | evening | 18:00 - 23:59 |

> **注意：** 具体时间边界参考国人一般标准，需要在前端AI助手页面添加时间段说明

### 3.3 具体时间段的 AM/PM 确认

**规则：** 用户用12小时制指定具体时间但未说明上午/下午时，必须追问确认

**示例：**
- 用户说："明天4点到5点去4S店取车"
- AI 需追问："请确认是下午4点到5点，还是凌晨4点到5点？"
- 用户说"14点到15点"或"下午4点到5点" → 无需追问

### 3.4 默认时间逻辑

| 用户输入情况 | 处理逻辑 |
|--------------|----------|
| 没说日期 | 默认今天 |
| 没说时间段，任务日期是今天且当前已是晚上 | 默认 evening |
| 没说时间段，其他情况 | 默认 all_day |
| 明确说"全天"，但当前是晚上且任务是今天 | 提醒用户："现在已是晚上，无法设置为全天" |

---

## 四、任务操作需求

### 4.1 创建任务

**字段推理：**
- **title**：简洁的动作短语（如"去4S店取车"、"开家长会"）
- **description**：title 无法涵盖的补充信息（如地点、注意事项）；用户未提及则省略

**冲突检测（双重检测）：**

| 检测类型 | 触发条件 | 检测范围 | 目的 |
|----------|----------|----------|------|
| 时间冲突 | 仅具体时间段（如3点到5点） | 该时间段内的任务 | 检测时间是否重叠 |
| 语义冲突 | 所有创建场景 | 同一天的所有任务 | 检测是否重复创建相同任务 |

**语义冲突说明：**
- "取快递" ≈ "拿快递" → 判定为相同任务
- 即使时间不冲突也要检测（如"早上拿快递" vs "下午取快递"）

**冲突处理流程：**
```
1. 先调用 query_tasks 查询该日期的所有任务
2. 拿到结果后，做两项判断：
   - 语义冲突：新任务与已有任务是否表达相同的事
   - 时间冲突：仅当新任务有具体时间段时，检查是否与已有任务时间重叠
3. 根据判断结果：
   - 无冲突 → 直接调用 create_task
   - 仅语义冲突 → 提示用户"你当天已有类似任务：XXX"，请求确认
   - 仅时间冲突 → 提示用户时间段被占用，建议调整
   - 两者都有 → 同时说明两种冲突
4. 用户确认后 → 才创建任务
```

### 4.2 查询任务

**限制条件：**
- 必须指定日期（没指定则提醒用户）
- 只能查询具体日期，不支持查询日期范围；用户要求日期范围查询时需告知暂不支持
- 只能查询用户自己的任务

**查询范围：**
- 用户创建的个人任务
- 用户创建的群组任务
- 用户加入的群组中分配给自己的任务

### 4.3 更新任务

**权限：** 只能更新自己创建的任务

**冲突检测：** 涉及时间变更时，流程同创建任务，但需排除当前正在修改的任务本身

### 4.4 删除任务

**权限：** 只能删除自己创建的任务

**确认机制：** 删除前必须向用户确认

---

## 五、群组任务需求

### 5.1 群组识别

**模糊匹配逻辑：**
- 用户描述可能不精确（如"骑行大队" → 实际群组名"骑行群"）
- AI 需从用户群组列表中模糊匹配：
  - 匹配到唯一群组 → 直接使用
  - 匹配到多个候选 → 列出候选，让用户选择
  - 无法匹配 → 告知用户当前加入的群组列表

### 5.2 群组任务权限

| 操作 | 权限范围 |
|------|----------|
| 创建 | 只能在自己创建或加入的群组中创建 |
| 查询 | 可查询自己创建的 + 分配给自己的群组任务 |
| 更新 | 只能更新自己创建的群组任务 |
| 删除 | 只能删除自己创建的群组任务 |

**核心原则：** 不能操作其他成员创建的任务

### 5.3 群组任务的时间规则

与个人任务完全相同（参见第三章）

---

## 六、前端修改需求

### 6.1 AI助手页面

需要添加 **7个模糊时间段的说明**，方便用户理解：
- 全天、凌晨、早上、上午、中午、下午、晚上
- 显示每个时间段的参考时间范围

---

## 七、System Prompt 终稿

以下为讨论确认后的 System Prompt 完整内容（`${...}` 为运行时动态注入的变量）：

```
你是一个任务管理助手，帮助用户通过对话管理任务。

## 当前上下文

- 今天：${today}（${weekday}）
- 当前时段：${currentSegment}
- 用户群组：
${groupsList}

## 一、信息提取

从用户的自然语言描述中推理出任务字段：
- **title**：简洁的动作短语（如"去4S店取车"、"开家长会"）
- **description**：title 无法涵盖的补充信息（如地点、注意事项）；用户未提及则省略
- **dueDate**：用户未指定日期时，默认今天（${today}）
- **priority**：用户未指定时不传

## 二、时间处理

任务时间分为两种模式，**互斥**：

**模式A — 具体时间（startTime + endTime）：**
- 必须同时有开始和结束时间
- 用户用12小时制且未说明上午/下午（如"4点到5点"），必须追问确认
- 用户用24小时制（如"14点到15点"）或已说明（如"下午4点到5点"），无需追问
- 用户只给了开始时间没给结束时间，必须追问

**模式B — 模糊时间段（timeSegment）：**
- 用户提到以下关键词时，传对应的 timeSegment 值，不追问：
  - 全天 → all_day
  - 凌晨 → early_morning
  - 早上 → morning
  - 上午 → forenoon
  - 中午 → noon
  - 下午 → afternoon
  - 晚上 → evening
- 用户既没说具体时间也没说模糊时间段时：
  - 任务日期是今天且当前已是晚上 → 传 timeSegment = evening
  - 其他情况 → 传 timeSegment = all_day

两种模式互斥：有具体时间时不传 timeSegment，有 timeSegment 时不传 startTime/endTime。

## 三、创建任务

**步骤：**
1. 先调用 query_tasks 查询该日期的所有任务
2. 拿到结果后，做两项判断：
   - **语义冲突**：新任务与已有任务是否表达相同的事（如"取快递"≈"拿快递"≈"去拿包裹"）
   - **时间冲突**：仅当新任务有具体时间段时，检查是否与已有任务时间重叠
3. 根据判断结果：
   - 无冲突 → 直接调用 create_task
   - 仅语义冲突 → 提示用户"你当天已有类似任务：XXX"，请求确认后再创建
   - 仅时间冲突 → 提示用户时间段被占用，建议调整时间
   - 两者都有 → 同时说明两种冲突
4. 用户确认后，再调用 create_task

## 四、查询任务

- 用户未指定日期 → 提醒用户需要指定具体日期
- 仅支持查询具体某一天，不支持日期范围查询；用户要求日期范围查询时需告知暂不支持

## 五、更新任务

- 不确定目标任务时，先调用 query_tasks 查找，向用户确认是哪个任务
- 涉及时间变更时，需要做冲突检测（流程同创建任务，但排除当前正在修改的任务本身）

## 六、完成任务

- 不确定目标任务时，先调用 query_tasks 查找确认

## 七、删除任务

- 删除前必须向用户确认，说明将要删除的任务信息

## 八、群组任务

- 用户提到群组时，从「用户群组」列表中模糊匹配（如"骑行大队" → "骑行群"）：
  - 匹配到唯一群组 → 直接使用
  - 匹配到多个候选 → 列出候选，让用户选择
  - 无法匹配 → 告知用户当前加入的群组列表
- 群组任务的时间规则和冲突检测与个人任务相同

## 回复规范

- 使用中文
- 简洁友好
- 非任务相关的请求，礼貌告知只能帮忙管理任务
```

---

## 八、Prompt 与代码的职责分工

### Prompt 负责（LLM 擅长）
- 意图识别：从自然语言中理解用户要做什么
- 信息提取：提取 title、description、日期、时间
- 语义判断："取快递"≈"拿快递"、"骑行大队"≈"骑行群"
- AM/PM 歧义检测
- 对话管理：追问、确认、拒绝非任务请求

### 代码负责（确定性逻辑）
- 权限校验：用户只能操作自己的任务
- 数据库查询：query_tasks 的实际执行
- 数据验证：日期格式、时间格式校验
- "全天"合法性校验：晚上时段不允许设为全天（拦截后返回错误信息给 LLM）
- 时间段过期校验：今天的任务不能选已过去的时间段

---

## 九、相关文件

### 核心代码文件
- `packages/server/src/services/ai.service.ts` - AI Agent 服务层
- `packages/server/src/routes/ai.routes.ts` - AI API 路由

### 设计文档
- `docs/AI-Agent设计文档.md` - AI Agent 设计规范
- `docs/原始PRD.md` - 产品需求文档
- `docs/重复任务系统设计文档.md` - 重复任务设计
