

# 部署与运行说明（Deployment）

> 本文档说明系统在**不同环境下的部署结构、运行边界与基本约定**。  
>  
> - 不绑定具体云厂商或运行平台  
> - 不规定 CI / CD 工具  
> - 用于指导从本地开发到生产环境的部署决策  

---

## 1. 文档定位

### 1.1 本文档负责

- 描述系统的逻辑部署结构
- 明确各组件的运行职责
- 定义环境之间的基本区分原则

### 1.2 本文档不负责

- 具体部署脚本
- 云资源创建细节
- 成本或性能优化策略

---

## 2. 系统部署视角总览

从部署角度，系统由以下部分组成：

- **API 服务**
- **数据库**
- **Device（展示终端）**

它们之间的关系是：

- API 是唯一的业务入口
- 数据库只被 API 访问
- Device 只读取 API 暴露的数据

---

## 3. 环境划分

系统至少应区分以下环境：

| 环境 | 用途 |
|---|---|
| local | 本地开发 |
| staging | 集成测试 / 预发布 |
| production | 正式使用 |

### 环境隔离原则

- 不同环境使用**不同数据库**
- 不同环境使用**不同 API 访问地址**
- 禁止 Device 直接连接非 production 环境（除调试）

---

## 4. API 服务部署

### 4.1 API 服务职责

- 接收 User 发起的请求
- 执行业务逻辑
- 读写数据库
- 向 Device 推送或提供只读数据

### 4.2 运行形式（非约束）

API 服务可以运行在：

- Serverless Functions
- 长驻 Node.js Server
- 容器化服务

选择不影响本文档约定。

---

### 4.3 API 服务配置（概念级）

API 服务通常需要以下配置项：

| 配置项 | 说明 |
|---|---|
| DATABASE_URL | 数据库连接地址 |
| ENV | 当前运行环境标识 |
| DEVICE_SECRET | Device 接入鉴权密钥 |

> 配置方式可以是环境变量、配置文件或平台 Secret。

---

## 5. 数据库部署

### 5.1 数据库角色

- 存储核心业务数据（User / Group / Task）
- 不对外暴露
- 只接受 API 服务访问

### 5.2 数据库选择原则

- 支持关系模型
- 支持事务
- 可轻松做备份与恢复

具体产品（PostgreSQL / SQLite / MySQL）由实现阶段决定。

---

## 6. Device 部署与接入

### 6.1 Device 的部署位置

Device 通常运行在：

- 家庭局域网
- 边缘设备
- 嵌入式系统

它不被视为“服务器”。

---

### 6.2 Device 与 API 的关系

- Device **不会**：
  - 写入业务数据
  - 创建或修改 Task
- Device **只会**：
  - 拉取或接收 Group 当前状态
  - 展示任务信息

---

### 6.3 Device 接入约定（概念）

- 每个 Device 拥有唯一标识
- Device 使用专用凭证与 API 通信
- Device 不继承 User 权限

---

## 7. 网络与安全边界（原则级）

- API 必须运行在受控网络中
- 数据库不可暴露公网
- Device 只能访问公开 API 接口

> 本文档不定义具体加密或认证算法，但要求**责任边界清晰**。

---

## 8. 日志与监控（最低要求）

系统至少应具备：

- API 请求日志
- 错误日志
- Device 连接状态记录

实现方式由平台决定。

---

## 9. 部署演进原则

- 早期优先 **简单与可理解**
- 所有复杂化（缓存、队列、多实例）：
  - 必须有明确动机
  - 应记录在 `technical-decisions.md`

---

## 10. 对 AI 的约束

当 AI 生成部署相关代码或配置时：

- ✅ 必须遵守本文档的组件边界
- ❌ 不得让 Device 直接访问数据库
- ❌ 不得引入未定义的服务角色

---

## 11. 维护说明

- 当部署结构发生变化时，应更新本文档
- 平台迁移不需要修改本文档
- 架构级变化必须同步技术决策记录

---

